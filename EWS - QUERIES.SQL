---------This are the Queries used to get the data for this task------------

--------1-----------------
CREATE TABLE CS_DETAIL_RETAIL AS
(
SELECT C.CIF_ID, G.ACID, FLOOR((SYSDATE -C.DATE_OF_BIRTH)/365) CUST_AGE, FLOOR((SYSDATE - C.CUST_OPN_DATE)/365) AGE_WITH_BANK, C.SEGMENTATION_CLASS, M.CUSTOMERINCOME, 
M.SECTOR, M.SUBSECTOR, S.SECURED_FLG,M.PHYSICALADDRESS, M.MARITALSTATUS, M.OTG_TRANSACTING, G.SCHM_CODE, S.SCHM_DESC, L.DIS_AMT, LHT.APPLICABLE_DATE + 21 DISB_DATE_3WK, 
LHT.APPLICABLE_DATE DISB_DATE, L.REP_PERD_MTHS, GAC.DPD_CNTR, LRS.FLOW_ID,  SUM(LRS.FLOW_AMT)FLOW_AMT, COUNT(LRS.FLOW_AMT) NO_OF_INSTALLMENTS 
FROM TBAADM.CMG@FINACLE C, TBAADM.GAM@FINACLE G, EDW.MDM_IMKE M, TBAADM.GSP@FINACLE S, TBAADM.LAM@FINACLE L, TBAADM.GAC@FINACLE GAC, TBAADM.LRS@FINACLE LRS, TBAADM.LHT@FINACLE
WHERE C.CIF_ID = G.CIF_ID 
AND C.CIF_ID = M.CUSTOMERID 
AND G.SCHM_CODE = S.SCHM_CODE 
AND L.ACID = G.ACID 
AND GAC.ACID = G.ACID 
AND LRS.ACID = G.ACID 
AND LHT.ACID = G.ACID 
AND C.SEGMENTATION_CLASS IN ('BL03', 'BL05') 
AND G.SCHM_CODE IN ('LAL03', 'LAL10', 'LAL27', 'LAL28', 'LAL29', 'LAL32', 'LAL02', 'LAF01', 'LAF06', 'LAF19', 'LAL03', 'LAL06', 'LAL10', 'LAL19', 'LAL21', 'LAL30', 'LAF30')
-- AND G.SCHM_CODE LIKE 'L%' 
AND TRUNC(LHT.APPLICABLE_DATE) BETWEEN '01-JAN-2022' AND '30-JUN-2023'
GROUP BY C.CIF_ID, G.ACID, C.DATE_OF_BIRTH, C.CUST_OPN_DATE, C.SEGMENTATION_CLASS, M.CUSTOMERINCOME, M.SECTOR, M.SUBSECTOR, S.SECURED_FLG,M.PHYSICALADDRESS, M.MARITALSTATUS, 
M.OTG_TRANSACTING, G.SCHM_CODE, S.SCHM_DESC, L.DIS_AMT, LHT.APPLICABLE_DATE, L.REP_PERD_MTHS, GAC.DPD_CNTR, LRS.FLOW_ID
);

--------------2---------------

CREATE TABLE CS_NON_LOAN_ACC_RETAIL AS 
(
SELECT A.CIF_ID, COUNT(DISTINCT A.ACID) NO_OF_NON_LOAN_ACCOUNTS 
FROM CS_DETAIL_RETAIL_2 D 
LEFT JOIN TBAADM.GAM@FIN10 A on D.CIF_ID = A.CIF_ID -- AND D.FORACID = A.FORACID
WHERE A.ACCT_CLS_FLG = 'N' 
AND A.SCHM_CODE NOT LIKE 'L%'
GROUP BY A.CIF_ID 
);

-------------3----------------------

CREATE TABLE CS_LOAN_ACC_RETAIL AS
(
SELECT A.CIF_ID, COUNT(DISTINCT A.ACID)LOAN_ACCT_PRIOR    --A.ACID, A.SCHM_CODE, ACCT_OPN_DATE 
FROM CS_DETAIL_RETAIL D 
LEFT JOIN TBAADM.GAM@FINACLE A on A.CIF_ID = D.CIF_ID
WHERE A.SCHM_CODE LIKE 'L%' 
GROUP BY A.CIF_ID
);

-----------4-----------------

CREATE TABLE CS_TRANS_RETAIL AS
(
SELECT * FROM 
(
WITH MAINCTE AS
(
SELECT D.CIF_ID, G.ACID, DISB_DATE, DISB_DATE_3WK FROM CS_DETAIL_RETAIL D
LEFT JOIN TBAADM.GAM@FINACLE G ON G.CIF_ID = D.CIF_ID
WHERE G.SCHM_CODE NOT LIKE 'L%' 
),
TRANSCTE AS
( 
SELECT H.ACID, H.TRAN_ID, H.PART_TRAN_TYPE, H.TRAN_CRNCY_CODE, H.TRAN_DATE, H.TRAN_AMT ORIGINAL_AMOUNT, 
CASE WHEN H.TRAN_CRNCY_CODE <> 'KES' THEN H.TRAN_AMT * VAR_CRNCY_UNITS ELSE H.TRAN_AMT END CONVERTED_AMOUNT
FROM TBAADM.HTD@FINACLE H
LEFT JOIN TBAADM.RTH@FINACLE RTH ON RTH.FXD_CRNCY_CODE = H.TRAN_CRNCY_CODE AND H.TRAN_DATE = RTH.RTLIST_DATE AND RTH.VAR_CRNCY_CODE = 'KES' AND RTH.RTLIST_NUM = 1 AND RTH.RATECODE = 'MID'
WHERE H.TRAN_PARTICULAR NOT LIKE '%REVERSAL%' 
AND H.TRAN_PARTICULAR NOT LIKE 'REV%'
AND TRAN_DATE BETWEEN '05-JAN-22' AND '21-JUL-23'
)
SELECT MAINCTE.CIF_ID, TRANSCTE.ACID, TRANSCTE.TRAN_ID, TRANSCTE.PART_TRAN_TYPE, TRANSCTE.TRAN_CRNCY_CODE, TRANSCTE.TRAN_DATE, TRANSCTE.ORIGINAL_AMOUNT,  CONVERTED_AMOUNT
FROM MAINCTE
LEFT JOIN TRANSCTE ON TRANSCTE.ACID = MAINCTE.ACID
)
);

---------------5-----------------------

CREATE TABLE CS_EOD_RETAIL AS
(
select a.CIF_ID, a.EOD_DATE, sum(a.CONVERTED_AMOUNT) as TRAN_DATE_BAL
from
(
SELECT D.CIF_ID, EAB.EOD_DATE, EAB.TRAN_DATE_BAL as ORIGINAL_AMOUNT,
CASE WHEN EAB_CRNCY_CODE <> 'KES' THEN SUM(EAB.TRAN_DATE_BAL * VAR_CRNCY_UNITS) ELSE SUM(EAB.TRAN_DATE_BAL)END CONVERTED_AMOUNT
FROM CS_DETAIL_RETAIL D
LEFT JOIN TBAADM.GAM@FINACLE G ON G.CIF_ID = D.CIF_ID 
LEFT JOIN TBAADM.EAB@FINACLE EAB ON  EAB.ACID = G.ACID
LEFT JOIN TBAADM.RTH@FINACLE RTH ON RTH.FXD_CRNCY_CODE = EAB_CRNCY_CODE AND EAB.EOD_DATE = RTH.RTLIST_DATE AND RTH.VAR_CRNCY_CODE = 'KES' AND RTH.RTLIST_NUM = 1 AND RTH.RATECODE = 'MID'
WHERE G.SCHM_CODE NOT LIKE 'L%' 
AND G.SCHM_CODE != 'CAL29'
--AND G.ACCT_CLS_FLG = 'N' 
AND EAB.EOD_DATE BETWEEN DISB_DATE AND DISB_DATE_3WK
GROUP BY D.CIF_ID, EAB.EOD_DATE, EAB.TRAN_DATE_BAL,EAB_CRNCY_CODE
/*AND EAB_CRNCY_CODE <> 'KES'
AND D.CIF_ID = '0045617'*/
)a
group by a.CIF_ID, a.EOD_DATE
);

------------6----------------

CREATE TABLE CS_OTG_RETAIL AS
(
SELECT D.CIF_ID, A.TRAN_ID, D.DISB_DATE, A.TRAN_DATE, TO_CHAR(A.TRAN_DATE, 'MON-YY')TRAN_MONTH, A.TRAN_AMOUNT
FROM CS_DETAIL_RETAIL D
LEFT JOIN IMKE.OTG_INDIVIDUAL_TRANSACTION_ANALYSIS A ON A.CUSTOMER_CIF = D.CIF_ID  AND A.TRAN_DATE BETWEEN D.DISB_DATE AND DISB_DATE_3WK
);







